 <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <%= csrf_meta_tags %>
    <link rel="stylesheet" type="text/css" href="devices.css">
    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>

    <title>Beta Presentation</title>

    <!-- Custom Fonts -->
    <!--<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">-->
    

</head>

<body id="page-top" class="index">
    <!-- Navigation -->
    <nav id="mainNav" class="aux navbar-custom">
        <div class="container-fluid">
            <div class="navbar-header page-scroll">
                <a class="navbar-brand">CinnamonHAB</a>
            </div>
        </div>
    </nav>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="row">
                <div class="col-lg-7 intro-text">
                    <span class="name" id="devices">Devices</span>
                </div>
                <div class="col-lg-5 intro-text">
                    <div class="row">
                        <span class="name" id="controls">Controls</span>                       
                    </div>
                    <div class="row">
                        <span class="name" id="modes">Modes</span>                       
                    </div>
                </div>
            </div>
                                   
        </div>
    </header>

</body>
<!-- Footer -->
    <footer class="text-center">
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                        Copyright &copy; CinnamonHAB 2016-2017
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script>
        document.body.onload = getItems();
        var itemClass = function (state, type, name, label, tags, groupNames) {
            this.state = state;
            this.type = type;
            this.name = name;
            this.label = label;
            this.tags = tags;
            this.groupNames = groupNames;
        }
        var deviceArray = new Array();
        var controlArray = new Array();
        var modeArray = new Array();
        var numDevices = 0;
        var numControls = 0;
        var numModes = 0;

        var numLights = 0;
        var numLightsOn = 0;

        var numDimmers = 0;
        
        function getItems()
        {
            var request = $.ajax ( {
                type       : "GET",
                url        : "http://localhost:3000/rest/getitems",
                headers    : { "Accept": "text/plain"},
            });
            request.done( function(data) { 
                console.log( "Success: Status=" + data );
                create(data);
            });
            request.fail( function(jqXHR, textStatus ) { 
                console.log( "Failure: " + textStatus );
            });
        }
        function create(data) {
            for(var i = 0; i <Object.keys(data).length; i++) {
                if(data[i].type == "Group") {
                    
                }else {
                    if(data[i].name.includes("action")) {
                        if(data[i].label.includes("Mode") || data[i].label.includes("mode")) {
                            addModeToArray(data[i]);
                            generateModeHTML(modeArray[numModes-1], numModes-1);
                        }else {
                            addControlToArray(data[i]);
                            generateControlHTML(controlArray[numControls-1], numControls-1);
                        }
                    }else {
                        addDeviceToArray(data[i]);
                        generateDeviceHTML(deviceArray[numDevices-1], numDevices-1);                   
                    }
                }
            }
        }
        //state, type, name, label, tags, groupNames
        function addModeToArray(mode) {
            if(mode.state == "NULL") {
                modeArray[numModes] = new itemClass("OFF", mode.type, mode.name, mode.label, mode.tags, mode.groupNames);
                updateState(modeArray[numModes].name, modeArray[numModes].state);
            }
            else
                modeArray[numModes] = new itemClass(mode.state, mode.type, mode.name, mode.label, mode.tags, mode.groupNames);
            numModes++;
        }
        //state, type, name, label, tags, groupNames
        function addControlToArray(control) {
            if(control.state == "NULL") {
                controlArray[numControls] = new itemClass("OFF", control.type, control.name, control.label, control.tags, control.groupNames);
                updateState(controlArray[numControls].name, controlArray[numControls].state);
            }
            else
                controlArray[numControls] = new itemClass(control.state, control.type, control.name, control.label, control.tags, control.groupNames);
            numControls++;
        }
        //state, type, name, label, tags, groupNames
        function addDeviceToArray(device) {
            if(device.state == "NULL") {
                deviceArray[numDevices] = new itemClass("OFF", device.type, device.name, device.label, device.tags, device.groupNames);
                updateState(deviceArray[numDevices].name, deviceArray[numDevices].state);
            }
            else
                deviceArray[numDevices] = new itemClass(device.state, device.type, device.name, device.label, device.tags, device.groupNames);
            numDevices++;
            if(isLight(device)) {
                numLights++;
                if(isDeviceOn(device)) {
                    numLightsOn++;
                }
            }
        }

        function isLight(device) {
            if(device.label.includes("Light"))
                return true;
            else
                return false;
        }

        function isTV(device) {
            if(device.label.includes("TV"))
                return true;
            else
                return false;
        }

        function isDeviceOn(device) {
            if(device.state == "ON")
                return true;
            else
                return false;
        }

        function generateModeHTML(mode, index) {
            var row = document.createElement("div");
            row.setAttribute('class','row');
            row.setAttribute('id', mode.name);
            var col = document.createElement("div");
            col.setAttribute('class','col-lg-2');
            var icon = generateIcon("mode", mode);
            col.appendChild(icon);
            row.appendChild(col);
            var col2 = document.createElement("div");
            col2.setAttribute('class','col-lg-7');
            var lab = generateLabel(mode);
            col2.appendChild(lab);
            row.appendChild(col2);
            var col3 = document.createElement("div");
            col3.setAttribute('class','col-lg-3');
            var b = generateFunctionButton("mode", mode, index);            
            col3.appendChild(b);
            row.appendChild(col3);
            
            var lastItem = document.getElementById("modes");
            modes.appendChild(row);
        }
        function generateControlHTML(control, index) {
            var row = document.createElement("div");
            row.setAttribute('class','row');
            row.setAttribute('id', control.name);
            var col = document.createElement("div");
            col.setAttribute('class','col-lg-2');
            var icon = generateIcon("control", control);
            col.appendChild(icon);
            row.appendChild(col);
            var col2 = document.createElement("div");
            col2.setAttribute('class','col-lg-7');
            var lab = generateLabel(control);
            col2.appendChild(lab);
            row.appendChild(col2);
            var col3 = document.createElement("div");
            col3.setAttribute('class','col-lg-3');
            var b = generateFunctionButton("control", control, index);            
            col3.appendChild(b);
            row.appendChild(col3);
            
            var lastItem = document.getElementById("controls");
            controls.appendChild(row);
        }
        function generateDeviceHTML(device, index) {
            var row = document.createElement("div");
            row.setAttribute('class','row');
            row.setAttribute('id', device.name);
            var col = document.createElement("div");
            col.setAttribute('class','col-lg-1');
            var icon = generateIcon("device", device);
            col.appendChild(icon);
            row.appendChild(col);
            var col2 = document.createElement("div");
            col2.setAttribute('class','col-lg-4');
            var lab = generateLabel(device);
            col2.appendChild(lab);
            row.appendChild(col2);
            var col3 = document.createElement("div");
            col3.setAttribute('class','col-lg-3');
            var b = generateFunctionButton("device", device, index);            
            col3.appendChild(b);
            row.appendChild(col3);
            /*
            var col4 = document.createElement("div");
            col4.setAttribute('class','col-lg-3');
            var del = generateRemoveDeviceButton(device, index);
            col4.appendChild(del);
            row.appendChild(col4);
            */
            
            var lastItem = document.getElementById("devices");
            devices.appendChild(row);
        }
        function generateIcon(type,item) {
            if(type == "device" || type == "control") {
                if(item.type == "Switch") {
                    var icon = document.createElement("img");
                    icon.setAttribute('class','icon');
                    if(item.label.includes("Light")) {
                        if(item.state == "OFF")
                            icon.setAttribute('src','<%= asset_path('light_OFF_light.png') %>');
                        else
                            icon.setAttribute('src','<%= asset_path('light_ON.png') %>');

                    }
                    else if(item.label.includes("TV")) {
                        if(item.state == "OFF")
                            icon.setAttribute('src','<%= asset_path('tv_OFF.png') %>');
                        else
                            icon.setAttribute('src','<%= asset_path('tv_ON.png') %>');
                    }else { //Default
                        if(item.state == "OFF")
                            icon.setAttribute('src','<%= asset_path('light_OFF_light.png') %>');
                        else
                            icon.setAttribute('src','<%= asset_path('light_ON.png') %>');
                    }                
                    icon.setAttribute('width','50');
                    icon.setAttribute('height','50');
                    icon.setAttribute('id', item.name+'icon')
                    return icon;
                }else {
                    //Default
                    var icon = document.createElement("img");
                    icon.setAttribute('class','icon');
                    icon.setAttribute('src','<%= asset_path('light_OFF_light.png') %>');
                    icon.setAttribute('width','50');
                    icon.setAttribute('height','50');
                    icon.setAttribute('id', item.name+'icon')
                    return icon;
                }
            }else {
                if(item.label.includes("Romantic")) {
                    var icon = document.createElement("img");
                    icon.setAttribute('class', 'icon');
                    if(item.state == "OFF")
                            icon.setAttribute('src','<%= asset_path('heart_OFF.png') %>');
                        else
                            icon.setAttribute('src','<%= asset_path('heart_ON.png') %>');
                    icon.setAttribute('width','50');
                    icon.setAttribute('height','50');
                    icon.setAttribute('id', item.name+'icon')
                    return icon;
                }else { //Default
                    var icon = document.createElement("img");
                    icon.setAttribute('class', 'icon');
                    icon.setAttribute('src', '<%= asset_path('heart_ON.png') %>');
                    icon.setAttribute('width','50');
                    icon.setAttribute('height','50');
                    icon.setAttribute('id', item.name+'icon')
                    return icon;
                }
            }
        }
        function generateLabel(item) {
            var lab = document.createElement('span');
            lab.innerHTML = item.label;
            lab.setAttribute('class','labels');
            lab.setAttribute('id', item.name+'label')
            return lab;
        }
        function generateFunctionButton(type, item, index) {
            if(item.type == "Switch") {
                var b = document.createElement('button');
                b.setAttribute('class', 'btn btn-primary');
                b.setAttribute('id', item.name+'button')
                if(type == "control") {
                    b.setAttribute('onclick', 'allLamps('+index+')');
                }else if (type == "mode") {
                    b.setAttribute('onclick', 'romanticMode('+index+')');
                }else {
                    b.setAttribute('onclick','switchIt('+index+')');
                }
                b.innerHTML = 'Turn ON/OFF';
                return b;
            }else if(item.type == "Dimmer") {
                var div = document.createElement('div');
                div.setAttribute('class', 'clickable');
                var div2 = document.createElement('div');
                div2.setAttribute('class', 'display');
                var div3 = document.createElement('div');
                div3.setAttribute('class', 'progress');
                div2.appendChild(div3);
                div.appendChild(div2);

                $('.clickable').bind('click', function (ev) {
                    var $div = $(ev.target);
                    var $display = $div.find('.display');

                    var offset = $div.offset();
                    var x = ev.clientX - offset.left;

                    $('.progress').width(x);
                });

                return div;
            }else {
                //Default
                var b = document.createElement('button');
                b.setAttribute('class', 'btn btn-primary');
                b.setAttribute('id', item.name+'button')
                b.setAttribute('onclick','switchIt(this.id,'+index+')');
                b.innerHTML = 'Turn ON/OFF';
                return b;
            }
        }

        function allLamps(index) {
            turnOffRomanticMode();
            for(var i=0; i< numDevices;i++) {
                if(isLight(deviceArray[i])) {
                    if(controlArray[index].state == "ON") {
                        if(isDeviceOn(deviceArray[i])) {
                            turnLightOff(i);
                        }
                    }
                    else {
                        if(!isDeviceOn(deviceArray[i])) {
                            turnLightOn(i);
                        }
                    }
                }
            }
            var icon = document.getElementById(controlArray[index].name+"icon");
            if(controlArray[index].state == "ON") {
                controlArray[index].state = "OFF";
                icon.src = "<%= asset_path('light_OFF_light.png') %>";
            }
            else {
                controlArray[index].state = "ON";
                icon.src = "<%= asset_path('light_ON.png') %>";
            }
        }
        function turnOffAllLightsControl() {
            for(var i=0; i< numControls;i++) {
                if(controlArray[i].label == "All Lights") {
                    if(controlArray[i].state == "ON") {
                        controlArray[i].state = "OFF";
                        var icon = document.getElementById(controlArray[i].name+"icon");
                        icon.src = "<%= asset_path('light_OFF_light.png') %>";
                        updateState(controlArray[i].name, controlArray[i].state);
                        break;
                    }
                }
            }
        }
        function turnOnAllLightsControl() {
            for(var i=0; i< numControls;i++) {
                if(controlArray[i].label == "All Lights") {
                    if(controlArray[i].state == "OFF") {
                        controlArray[i].state = "ON";
                        var icon = document.getElementById(controlArray[i].name+"icon");
                        icon.src = "<%= asset_path('light_ON.png') %>";
                        updateState(controlArray[i].name, controlArray[i].state);
                        break;
                    }
                }
            }
        }

        function turnLightOn(index) {
            var icon = document.getElementById(deviceArray[index].name+"icon");
            icon.src = "<%= asset_path('light_ON.png') %>";
            deviceArray[index].state = "ON";
            numLightsOn++;
            updateState(deviceArray[index].name, deviceArray[index].state);
            sendCommand(deviceArray[index].name, deviceArray[index].state);
        }

        function turnLightOff(index) {
            var icon = document.getElementById(deviceArray[index].name+"icon");
            icon.src = "<%= asset_path('light_OFF_light.png') %>";
            deviceArray[index].state = "OFF";
            numLightsOn--;
            updateState(deviceArray[index].name, deviceArray[index].state);
            sendCommand(deviceArray[index].name, deviceArray[index].state);
        }

        function turnTVOn(index) {
            var icon = document.getElementById(deviceArray[index].name+"icon");
            icon.src = "<%= asset_path('tv_ON.png') %>";
            deviceArray[index].state = "ON";
            updateState(deviceArray[index].name, deviceArray[index].state);
            sendCommand(deviceArray[index].name, deviceArray[index].state);
        }

        function turnTVOff(index) {
            var icon = document.getElementById(deviceArray[index].name+"icon");
            icon.src = "<%= asset_path('tv_OFF.png') %>";
            deviceArray[index].state = "OFF";
            updateState(deviceArray[index].name, deviceArray[index].state);
            sendCommand(deviceArray[index].name, deviceArray[index].state);
        }

        function romanticMode(index) {
            var lightsOn = 0;
            turnOffAllLightsControl();
            for(var i=0; i< numDevices;i++) {
                if(isLight(deviceArray[i])) {
                    if(modeArray[index].state == "ON") {
                        turnLightOff(i);
                    }
                    else {
                        if(lightsOn == 0) {
                            turnLightOn(i);
                            lightsOn = 1;
                        }else {
                            turnLightOff(i);
                        }
                    }
                }else if(isTV(deviceArray[i])) {
                    if(modeArray[index].state == "ON") {
                        turnTVOff(i);
                    }
                    else {
                        turnTVOn(i);
                    }
                }
            }
            if(modeArray[index].state == "ON") {
                turnOffRomanticMode(index);
            }
            else {
                turnOnRomanticMode(index);
            }                            
        }

        function turnOffRomanticMode(index) {
            if(modeArray[index].label == "Romantic mode") {
                if(modeArray[index].state == "ON") {
                    modeArray[index].state = "OFF";
                    var icon = document.getElementById(modeArray[index].name+"icon");
                    icon.src = "<%= asset_path('heart_OFF.png') %>";
                    updateState(modeArray[index].name, modeArray[index].state);
                    sendCommand(modeArray[index].name, modeArray[index].state);
                }
            }
        }

        function turnOnRomanticMode(index) {
            if(modeArray[index].label == "Romantic mode") {
                if(modeArray[index].state == "OFF") {
                    modeArray[index].state = "ON";
                    var icon = document.getElementById(modeArray[index].name+"icon");
                    icon.src = "<%= asset_path('heart_ON.png') %>";
                    updateState(modeArray[index].name, modeArray[index].state);
                    sendCommand(modeArray[index].name, modeArray[index].state);
                }
            }
        }

        function turnOffRomanticMode() {
            for(var i=0; i< numModes;i++) {
                if(modeArray[i].label == "Romantic mode") {
                    if(modeArray[i].state == "ON") {
                        modeArray[i].state = "OFF";
                        var icon = document.getElementById(modeArray[i].name+"icon");
                        icon.src = "<%= asset_path('heart_OFF.png') %>";
                        updateState(modeArray[i].name, modeArray[i].state);
                        sendCommand(modeArray[i].name, modeArray[i].state);
                        break;
                    }
                }
            }
        }
        
        function switchIt(index) {
            turnOffRomanticMode();
            var icon = document.getElementById(deviceArray[index].name+"icon");
            if (deviceArray[index].state == "ON") {
                deviceArray[index].state = "OFF";
                if(deviceArray[index].label.includes("Light")) {
                    icon.src = "<%= asset_path('light_OFF_light.png') %>";
                    numLightsOn--;
                    turnOffAllLightsControl();
                }else if (deviceArray[index].label.includes("TV")) {
                    icon.src = "<%= asset_path('tv_OFF.png') %>";
                }else //TEMPORARY
                    icon.src = "<%= asset_path('light_OFF_light.png') %>";
            }
            else {
                deviceArray[index].state = "ON";
                if(deviceArray[index].label.includes("Light")) {
                    icon.src = "<%= asset_path('light_ON.png') %>";
                    numLightsOn++;
                    if(numLightsOn == numLights)
                        turnOnAllLightsControl();
                }else if (deviceArray[index].label.includes("TV")) {
                    icon.src = "<%= asset_path('tv_ON.png') %>";
                }else //TEMPORARY
                    icon.src = "<%= asset_path('light_ON.png') %>";
            }
            updateState(deviceArray[index].name, deviceArray[index].state);
            sendCommand(deviceArray[index].name, deviceArray[index].state);
        }

        function generateRemoveDeviceButton(device, index) {
            var b = document.createElement('button');
            b.setAttribute('class', 'btn btn-primary');
            b.setAttribute('id', device.name+'removebutton')
            b.setAttribute('onclick','removeIt('+index+')'); //\'device\',
            b.innerHTML = 'Remove Device';
            return b;
        }

        function removeIt(index) {
            deleteItem(deviceArray[index].name);
            for(var i=index; i < numDevices; i++) {
                deviceArray[index] = deviceArray[index+1];
            }
            numDevices--;
        }

        function updateState( item, txtNewState ) {
            var request = $.ajax ( {
                type       : "PUT",
                url        : "http://localhost:3000/rest/updatestate" ,
                data       : item+" "+txtNewState,
                headers    : { 'Content-Type': 'text/plain', 'Accept': 'text/plain' },
            });

            request.done( function(data) { 
                console.log( "Success: Status=" + data );
            });

            request.fail( function(jqXHR, textStatus ) { 
                console.log( "Failure: " + textStatus );
            });
        }
        function sendCommand( item, txtCommand ) {
            var request = $.ajax ( {
                type       : "POST",
                url        : "http://localhost:3000/rest/sendcommand" ,
                data       : item+" "+txtCommand,
                headers    : { 'Content-Type': 'text/plain', 'Accept': 'text/plain' },
            });

            request.done( function(data) { 
                console.log( "Success: Status=" + data );
            });

            request.fail( function(jqXHR, textStatus ) { 
                console.log( "Failure: " + textStatus );
            });
        }
        function getState(item)
        {
            var request = $.ajax ( {
                type       : "GET",
                url        : "localhost:3000/rest/getstate",
                data       : item,
                headers    : { "Accept": "text/plain"},
            });

            request.done( function(data) { 
                console.log( "Success: Status=" + data );
            });

            request.fail( function(jqXHR, textStatus ) { 
                console.log( "Failure: " + textStatus );
            });
        }

        function deleteItem(item)
        {
            var request = $.ajax ( {
                type       : "DELETE",
                url        : "localhost:3000/rest/deleteitem",
                data       : item,
                headers    : { 'Content-Type': 'text/plain', "Accept": "text/plain"},
            });

            request.done( function(data) { 
                console.log( "Success: Status=" + data );
            });

            request.fail( function(jqXHR, textStatus ) { 
                console.log( "Failure: " + textStatus );
            });
        }
        
        
    </script>
</html>   
